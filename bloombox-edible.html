
<!--
`<bloombox-edible>` provides UI for creating and managing edible cannabis products.

@group Bloombox Elements
@element bloombox-testing
@demo demo/index.html
@homepage bloombox.github.io
-->

<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-label/iron-label.html">

<link rel="import" href="../paper-card/paper-card.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-input/paper-textarea.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-slider/paper-slider.html">
<link rel="import" href="../paper-checkbox/paper-checkbox.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">

<link rel="import" href="../bloombox-media/bloombox-media.html">
<link rel="import" href="../bloombox-styles/bloombox-styles.html">
<link rel="import" href="../bloombox-testing/bloombox-testing.html">
<link rel="import" href="../bloombox-pricelist/bloombox-price.html">


<dom-module id="bloombox-edible">
  <template>
    <style is="custom-style" include="bloombox-styles">
    </style>

    <template is="dom-if" if="[[!zerostate]]">
      <paper-card heading="[[name]]" class="product-card edible-product data-content fullwidth">
        <div class="card-content">
          <!-- Edible Description -->
          <div class="row description-container">
            <template is="dom-if" if="[[!_slim]]">
              <template is="dom-if" if="[[description]]">
                <div class="product-description">[[description]]</div>
              </template>
              <template is="dom-if" if="[[!description]]">
                <div class="edible-no-description">(No description)</div>
              </template>
            </template>
          </div><!-- end div.row.description-container -->

          <!-- Stock Flags -->
          <div class="stock-flags edible-info test-info row">
            <!-- MPMH -->
            <iron-label class="premium-label" hidden$="[[!premium]]"><span>[[_renderPremiumLabel(partner)]]</span></iron-label>

            <!-- Sale -->
            <iron-label class="sale-label" hidden$="[[!sale]]"><span>[[sale]]% OFF</span></iron-label>

            <!-- Buy-One-Get-One -->
            <iron-label class="bogo-label" hidden$="[[!bogo]]"><span>Buy One Get One</span></iron-label>

            <!-- Vegan -->
            <iron-label class="vegan-label" hidden$="[[!vegan]]"><span>Vegan</span></iron-label>

            <!-- Organic -->
            <iron-label class="organic-label" hidden$="[[!organic]]"><span>Organic</span></iron-label>

            <!-- Gluten Free -->
            <iron-label class="glutenfree-label" hidden$="[[!glutenfree]]"><span>Gluten Free</span></iron-label>

            <!-- Test Results -->
            <bloombox-testing
              mode="basic"
              thc="[[tests.thc]]"
              cbd="[[tests.cbd]]"></bloombox-testing>
          </div><!-- end div.row.stock-flags -->

          <!-- Product Media -->
          <div class="edible-media row">
            <div class="bloombox-media-wrap">
              <bloombox-media hidden$="[[_shouldHideImage()]]" disabled partner="[[partner]]" asset="[[_image]]"></bloombox-media>
            </div><!-- end div.bloombox-media-wrap -->
          </div><!-- end .row.edible-media -->

          <!-- Price List -->
          <div class="row pricelist">
            <bloombox-price
              class="edibleSealedPrice"
              price="[[pricing.unit.value]]"
              available="[[pricing.unit.available]]"
              currency="$"></bloombox-price>
          </div><!-- end div.row.pricelist -->
          <template is="dom-if" if="[[!visible]]">
            <div class="not-in-stock-overlay not-in-stock"></div><!-- end div.edible-overlay.not-in-stock -->
          </template>
        </div><!-- end div.card-content -->
        <div class="card-actions">
          <paper-button on-tap="toggleEditing"><iron-icon icon="create"></iron-icon>Edit</paper-button>
          <paper-button on-tap="triggerDelete"><iron-icon icon="delete"></iron-icon>Delete</paper-button>
        </div>
      </paper-card><!-- end paper-card.product-card.data-content.edible-product -->
    </template>

    <template is="dom-if" if="[[zerostate]]">
      <paper-card header="Edible" class="product-card edible-product zerostate fullwidth">
        <div class="card-content">
          <div class="basic-info row">
            <!-- Edible Name & Description -->
            <paper-input id="brandField" placeholder="Brand Name" value="{{brand}}" required no-label-float name="brand" class="form-item edible-brand"></paper-input>
            <paper-input id="nameField" placeholder="Product Name" value="{{name}}" required no-label-float name="name" class="form-item edible-name"></paper-input>
            <paper-textarea id="descriptionField" label="Description" value="{{description}}" no-label-float name="description" class="form-item edible-description"></paper-textarea>
            <paper-dropdown-menu id="typeField" label="Edible Type" class="form-item" noink no-label-float required name="type">
              <paper-listbox class="dropdown-content" selected="{{type}}">
                <paper-item>Baked Good</paper-item>
                <paper-item>Chocolate</paper-item>
                <paper-item>Candy</paper-item>
                <paper-item>Other</paper-item>
              </paper-listbox>
            </paper-dropdown-menu><!-- end paper-dropdown-menu#typeField -->
          </div><!-- end .row.basic-info -->

          <!-- Pricing/Sale Flags -->
          <div class="stock-flags row">
            <div class="row-label">
              <span class="row-label-value">Inventory</span>
            </div><!-- end div.row-label -->

            <div class="in-stock-toggle-option">
              <paper-checkbox id="showToggle" checked="{{visible}}" class="form-item show-item-toggle" noink>In Stock</paper-checkbox>
            </div><!-- end .in-stock-toggle-option -->

            <div class="premium-toggle-option">
              <paper-checkbox id="premiumToggle" checked="{{premium}}" class="form-item premium-toggle" noink>[[_renderPremiumLabel(partner)]]</paper-checkbox>
            </div><!-- end .premium-toggle-option -->

            <div class="sale-toggle-option">
              <div class="sale-toggle-container">
                <paper-checkbox id="saleToggle" checked="[[isOnSale()]]" on-tap="toggleSale" class="form-item sale-toggle" noink>On Sale</paper-checkbox>
              </div><!-- end .sale-toggle-container -->
              <template is="dom-if" if="{{sale}}">
                <div class="sale-amount-container">
                  <paper-slider id="saleValue" pin value="{{sale}}" max="95" min="5" editable step="5" class="form-item"></paper-slider>
                </div><!-- end .sale-amount-container -->
                <div class="sale-percentage-label">% off</div>
              </template>
            </div><!-- end .sale-toggle-option -->

            <div class="bogo-toggle-option">
              <paper-checkbox id="bogoToggle" checked="{{bogo}}" class="form-item item-bogo-toggle" noink>Buy One, Get One</paper-checkbox>
            </div><!-- end .bogo-toggle-option -->

            <div class="organic-toggle-option">
              <paper-checkbox id="organicToggle" checked="{{organic}}" class="form-item item-organic-toggle" noink>Organic</paper-checkbox>
            </div><!-- end .organic-toggle-option -->

            <div class="vegan-toggle-option">
              <paper-checkbox id="veganToggle" checked="{{vegan}}" class="form-item item-vegan-toggle" noink>Vegan</paper-checkbox>
            </div><!-- end .vegan-toggle-option -->

            <div class="glutenfree-toggle-option">
              <paper-checkbox id="glutenfreeToggle" checked="{{glutenfree}}" class="form-item item-glutenfree-toggle" noink>Gluten Free</paper-checkbox>
            </div><!-- end .glutenfree-toggle-option -->
          </div><!-- end .row.stock-flags -->

          <!-- Test Results -->
          <div class="test-results row">
            <div class="row-label">
              <span class="row-label-value">Testing</span>
            </div><!-- end div.row-label -->

            <paper-checkbox id="testsToggle" checked="[[knownTestResults()]]" on-tap="toggleTests" class="form-item tests-toggle" noink>Test Results</paper-checkbox>
            <div class="test-results-container">
              <template is="dom-if" if="{{tests}}">
                <bloombox-testing
                  id="productTesting"
                  zerostate
                  mode="basic"
                  thc="{{tests.thc}}"
                  cbd="{{tests.cbd}}"></bloombox-testing>
              </template>
            </div><!-- end .test-results-container -->
          </div><!-- end .row.test-results -->

          <!-- Price List -->
          <div class="row pricelist">
            <bloombox-price
              id="edibleEditablePrice"
              editable
              price="{{pricing.unit.value}}"
              available="{{pricing.unit.available}}"
              currency="$"></bloombox-price>
          </div><!-- end div.row.pricelist -->
        </div><!-- end div.card-content -->

        <!-- Actions -->
        <template is="dom-if" if="[[editing]]">
          <div class="edible-zerostate-actions card-actions row">
            <paper-button id="saveButton" raised on-tap="commitEdits"><iron-icon icon="save"></iron-icon>Save</paper-button>
            <paper-button id="cancelButton" on-tap="cancelEdits"><iron-icon icon="cancel"></iron-icon>Cancel</paper-button>
          </div><!-- end .edible-zerostate-actions.card-actions -->
        </template>
        <template is="dom-if" if="[[!editing]]">
          <div class="edible-zerostate-actions edit-actions card-actions row">
            <paper-button id="submitButton" raised on-tap="persist"><iron-icon icon="check-circle"></iron-icon>Create</paper-button>
            <paper-button id="discardButton" on-tap="toggleAddEntry"><iron-icon icon="cancel"></iron-icon>Discard</paper-button>
          </div><!-- end .edible-zerostate-actions.card-actions.edit-actions -->
        </template>
      </paper-card><!-- end paper-card.product-card.zerostate.edible-product -->
    </template>
  </template>

  <script>
    Polymer({

      is: 'bloombox-edible',

      properties: {
        /**
         * Computes the current image/asset value, depending on how many `photos` are specified.
         */
        _image: {
          type: String,
          notify: true,
          computed: '_computeImage(photos)'
        },

        /**
         * Computes whether we are operating in `slim` display mode.
         */
        _slim: {
          type: Boolean,
          notify: true,
          computed: '_computeSlimMode(displayMode)'
        },

        /**
         * Display mode for the widget. Supported modes are `normal` and `slim`:
         * - `normal`: Displays all available/specified widget data
         * - `slim`: Omits description and product image
         */
        displayMode: {
          type: String,
          value: 'normal',
          notify: true,
          reflectToAttribute: true
        },

        /**
         * Flag indicating that we are in a mode that demands a form to edit the data backing
         * this widget. Combined with `editing`, this means we are either creating
         * (`editing=false`) or editing an existing item.
         */
        zerostate: {
          type: Boolean,
          value: false,
          notify: true,
          reflectToAttribute: true
        },

        /**
         * Flag indicating that we are in a mode where we are editing an existing item, not
         * creating a new one.
         */
        editing: {
          type: Boolean,
          value: false,
          notify: true,
          reflectToAttribute: true
        },

        /**
         * Object key for the current item. Provided by underlying persistence and unavailable
         * until a new entry is stored.
         */
        key: {
          type: String,
          notify: true,
          reflectToAttribute: true
        },

        /**
         * String name of the brand that produces and/or distributes this product. Usually a
         * simple string such as `"Kiva"` or `"Absolute Extracts"`.
         */
        brand: {
          type: String,
          notify: true,
          reflectToAttribute: true
        },

        /**
         * String value of the `type` of this current item. This property varies by item type.
         * In `<bloombox-edible>`'s case, the following values are selectable:
         * - `Chocolate`
         * - `Baked Good`
         * - `Candy`
         * - `Other`
         */
        type: {
          type: String,
          notify: true,
          reflectToAttribute: true
        },

        /**
         * String name of the current product itself. Usually a simple string such as
         * "Milk Chocolate Bar" or "High-strength CBD Cartridge".
         */
        name: {
          type: String,
          notify: true,
          reflectToAttribute: true
        },

        /**
         * Extended description for this product. Optional, hidden from the UI if not specified
         * by the menu administrator.
         */
        description: {
          type: String,
          notify: true,
          reflectToAttribute: true
        },

        /**
         * Array of images attached to this product as media, if any. Provides an empty array
         * by default to facilitate blind `.push()`.
         */
        photos: {
          type: Array,
          notify: true,
          reflectToAttribute: true,
          value: function() {
            return [];
          }
        },

        /**
         * Object specifying QA test results for this product. This is expressable in two major
         * forms, `rich` and `basic` (refer to the `<bloombox-testing>` documentation for more).
         *
         * Each product is coded to one or the other test result structure. In the case of
         * `<bloombox-edible>`, only `basic` testing (`cbd` and `thc` values) is supported.
         */
        tests: {
          type: Object,
          notify: true,
          reflectToAttribute: true
        },

        /**
         * Object specifying product pricing. This is specified in either weighted pricing (i.e.
         * pricing per-gram or per-ounce), which is generally used for raw product, namely
         * flowers and concentrates.
         *
         * `<bloombox-edible>` uses per-unit pricing, and returns an object in that structure by
         * default.
         */
        pricing: {
          type: Object,
          notify: true,
          reflectToAttribute: true,
          value: function() {
            return {"unit": {"available": true, "value": 0}};
          }
        },

        /**
         * Value specifying the amount that this product is currently on-sale, if any. No value
         * or a value of `0` is interpreted to mean "not on sale."
         */
        sale: {
          type: Number,
          notify: true,
          reflectToAttribute: true
        },

        /**
         * Flag value indicating that this item is on sale, such that buying one will get you
         * an additional item for free.
         */
        bogo: {
          type: Boolean,
          notify: true,
          reflectToAttribute: true,
          value: false
        },

        /**
         * Flag value indicating that this item meets a vegan person's dietary requirements
         * and/or is marketed towards that community.
         */
        vegan: {
          type: Boolean,
          notify: true,
          reflectToAttribute: true,
          value: false
        },

        /**
         * Flag value indicating that this item is organic.
         */
        organic: {
          type: Boolean,
          notify: true,
          reflectToAttribute: true,
          value: false
        },

        /**
         * Flag value indicating that this item is free of Gluten, and/or is marketed towards
         * the gluten free community.
         */
        glutenfree: {
          type: Boolean,
          notify: true,
          reflectToAttribute: true,
          value: false
        },

        /**
         * Boolean flag indicating whether this item is currently visible on the menu.
         */
        visible: {
          type: Boolean,
          notify: true,
          reflectToAttribute: true,
          value: true
        },

        /**
         * Boolean flag indicating whether this item should be flagged as "Top Shelf"/"MPMH"
         * or not.
         */
        premium: {
          type: Boolean,
          notify: true,
          reflectToAttribute: true
        },

        /**
         * Specifies the currently-active partner, to facilitate the generation of asset/media
         * URLs and upload files to the right place.
         */
        partner: {
          type: String,
          notify: true,
          value: "mm"
        }
      },

      _computeImage: function(photos) {
        if (Array.isArray(photos) && photos.length > 0)
          return photos[0];
        return null;
      },

      _computeSlimMode: function(displayMode) {
          return displayMode == "slim";
      },

      _shouldHideImage: function() {
        // we should hide the image if:
        // 1) we are in slimline mode
        // 2) there is no image and we are in zero-state
        var image = this.get("_image"),
            slim = this.get("_slim") || false;
        return (slim || !image);
      },

      _renderPremiumLabel: function(partner) {
        if (partner === "abatin")
          return "MPMH";
        return "Top Shelf";
      },

      isOnSale: function() {
        return this.sale !== undefined && this.sale > 0;
      },

      toggleSale: function() {
        this.sale = this.$$("#saleToggle").checked ?
            20 : undefined;
      },

      toggleTests: function() {
        this.tests = this.$$("#testsToggle").checked ?
            {} : undefined;
      },

      knownTestResults: function() {
        return this.tests !== undefined && this.tests !== null && typeof this.tests == "object";
      },

      commitEdits: function(callback) {
        var previous = this.readObjectData(),
            serialized = this.readZeroStateForm()
            that = this;
        console.log("Committing edits...", previous, serialized);
        bloom.app.saveEditsForEntry("edibles", this.get("key"), previous, serialized, function (error) {
          // handle edit success/fail
          if (error) {
            console.error("Failed to save edits for item: ", this, error);
            alert('Failed to apply edits.');
          } else {
            console.log("Edits applied successfully.");
            if (callback !== undefined && typeof callback === "function")
              callback();
            that.set("editing", false);
            that.set("zerostate", false);
          }
        });
      },

      cancelEdits: function() {
        console.log("Cancelled staged edits for item.");
        this.set("editing", false);
        this.set("zerostate", false);
      },

      persist: function() {
          bloom.app.saveNewObject("edibles", this.readZeroStateForm());  // read the form into our object
      },

      triggerDelete: function() {
        console.log("Deleting item...", this);
        bloom.app.deleteEntryAtId("edibles", this.get("key"));
      },

      toggleAddEntry: function() {
        bloom.app.toggleAddEntry();
      },

      toggleEditing: function() {
        console.log("Editing item...", this);
        this.set("editing", true);
        this.set("zerostate", true);
      },

      readObjectData: function() {
        var payload = {};

        // handle required fields
        payload.name = this.get("name");
        payload.brand = this.get("brand");
        payload.type = this.get("type");
        payload.photos = this.get("photos") || [];

        // handle test results
        if (this.get("tests") !== undefined && this.get("tests") != null) {
          payload.tests = {
            thc: this.get("tests").thc,
            cbd: this.get("tests").cbd
          };
        }

        // handle optional fields
        if (this.get("premium") == true) {
          payload.flags = payload.flags || {};
          payload.flags.premium = true;
        }
        if (this.get("sale") !== undefined && this.get("sale") != null) {
          payload.flags = payload.flags || {};
          payload.flags.sale = this.get("sale");
        }
        if (this.get("visible") != null && this.get("visible") != undefined) {
          payload.flags = payload.flags || {};
          payload.flags.visible = this.get("visible");
        }
        if (this.get("bogo") != null && this.get("bogo") != undefined) {
          payload.flags = payload.flags || {};
          payload.flags.bogo = this.get("bogo");
        }
        if (this.get("vegan") != null && this.get("vegan") != undefined) {
          payload.flags = payload.flags || {};
          payload.flags.vegan = this.get("vegan");
        }
        if (this.get("organic") != null && this.get("organic") != undefined) {
          payload.flags = payload.flags || {};
          payload.flags.organic = this.get("organic");
        }
        if (this.get("glutenfree") != null && this.get("glutenfree") != undefined) {
          payload.flags = payload.flags || {};
          payload.flags.glutenfree = this.get("glutenfree");
        }
        if (this.get("description") !== undefined && this.get("description") !== null &&
            this.get("description").length > 0) payload.description = this.get("description");
        return payload;
      },

      readZeroStateForm: function() {
        var payload = {},
            priceValue = this.$$("#edibleEditablePrice").value,
            priceAvailable = this.$$("#edibleEditablePrice").available,
            pricelist = {},
            mi, mpayload, testing;

        // handle required fields
        payload.name = this.$$("#nameField").value;
        payload.brand = this.$$("#brandField").value;
        payload.type = this.$$("#typeField").value;
        
        if (this.get("photos") && this.get("photos").length > 0)
          payload.photos = this.get("photos");

        // handle test results
        if (this.$$("#testsToggle").checked) {
          testing = this.$$("#productTesting");
          payload.tests = {
            thc: testing.thc,
            cbd: testing.cbd,
            terpenes: {
              pinene: testing.pinene,
              myrcene: testing.myrcene,
              limonene: testing.limonene,
              caryophyllene: testing.caryophyllene,
              linalool: testing.linalool
            }
          };
        }

        payload.pricing = {
          unit: {
            available: priceAvailable,
            value: priceValue
          }
        }

        // handle optional fields
        if (this.$$("#premiumToggle").checked) {
          payload.flags = payload.flags || {};
          payload.flags.premium = true;
        }
        if (this.$$("#showToggle").checked) {
          payload.flags = payload.flags || {};
          payload.flags.visible = true;
        } else {
          payload.flags = payload.flags || {};
          payload.flags.visible = false;
        }
        if (this.$$("#bogoToggle").checked) {
          payload.flags = payload.flags || {};
          payload.flags.bogo = true;
        }
        if (this.$$("#saleToggle").checked) {
          payload.flags = payload.flags || {};
          payload.flags.sale = this.$$("#saleValue").value;
        }
        if (this.$$("#veganToggle").checked) {
          payload.flags = payload.flags || {};
          payload.flags.vegan = true;
        }
        if (this.$$("#organicToggle").checked) {
          payload.flags = payload.flags || {};
          payload.flags.organic = true;
        }
        if (this.$$("#glutenfreeToggle").checked) {
          payload.flags = payload.flags || {};
          payload.flags.glutenfree = true;
        }
        if (this.$$("#descriptionField").value !== undefined && this.$$("#descriptionField").value.length > 0)
          payload.description = this.$$("#descriptionField").value;
        return payload;
      }
    });
  </script>
</dom-module>
